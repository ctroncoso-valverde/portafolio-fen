<!DOCTYPE html>
<html lang="es" translate="no">
<head>
<meta charset="UTF-8">
<meta name="google" content="notranslate">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portafolio Acad√©mico ¬∑ FEN-UNAB</title>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',-apple-system,system-ui,sans-serif;background:#f1f5f9}
.login-bg{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0c1829 0%,#1a365d 50%,#1e3a5f 100%);padding:20px}
.login-card{background:#fff;border-radius:16px;padding:48px 40px;max-width:440px;width:100%;box-shadow:0 25px 60px rgba(0,0,0,.3)}
.login-card h1{font-size:22px;font-weight:700;color:#111827;margin:0 0 8px}
.login-card .sub{font-size:14px;color:#6b7280;margin:0 0 28px;line-height:1.5}
.login-card .foot{font-size:12px;color:#9ca3af;text-align:center;margin-top:20px}
.ig{margin-bottom:20px}
.ig label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
.input,.sel,.ta{width:100%;padding:10px 14px;border:1.5px solid #d1d5db;border-radius:8px;font-size:15px;outline:none;font-family:inherit;box-sizing:border-box;transition:border .2s}
.input:focus,.sel:focus,.ta:focus{border-color:#0d4f8b;box-shadow:0 0 0 3px rgba(13,79,139,.1)}
.sel{font-size:14px;background:#fff}.ta{font-size:14px;resize:vertical}
.btn-p{width:100%;padding:12px;background:#0d4f8b;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;font-family:inherit;transition:background .2s}
.btn-p:hover{background:#093d6b}.btn-p:disabled{opacity:.5;cursor:not-allowed}
.btn-s{width:100%;padding:12px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;font-family:inherit}
.btn-o{display:inline-block;padding:10px 24px;background:transparent;color:#0d4f8b;border:1.5px solid #0d4f8b;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px;cursor:pointer;font-family:inherit;border:1px solid #d1d5db;background:#fff;color:#374151}
.btn-sm:hover{background:#f3f4f6}
.btn-warn{padding:6px 14px;font-size:12px;border-radius:6px;cursor:pointer;font-family:inherit;border:1px solid #fbbf24;background:#fffbeb;color:#92400e}
.err{padding:10px 14px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#991b1b;font-size:13px;margin-bottom:16px;line-height:1.5}
.main{min-height:100vh;background:#f1f5f9}
.hdr{background:#0c1829;padding:0 24px;height:56px;display:flex;align-items:center;position:sticky;top:0;z-index:100}
.hdr-in{max-width:1100px;width:100%;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.hdr-t{font-size:14px;color:#94a3b8;font-weight:500}.hdr-u{font-size:13px;color:#64748b}
.cnt{max-width:1100px;margin:0 auto;padding:32px 24px}
.card{background:#fff;border-radius:12px;padding:32px;box-shadow:0 1px 3px rgba(0,0,0,.08);border:1px solid #e2e8f0}
.card-c{text-align:center;padding:60px 40px}
.ph{display:flex;align-items:center;gap:20px;margin-bottom:28px}
.av{width:56px;height:56px;border-radius:50%;background:#0d4f8b;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;flex-shrink:0}
.pn{font-size:22px;font-weight:700;color:#111827;margin:0}.pe{font-size:14px;color:#6b7280;margin:4px 0 0}
.pg{display:flex;flex-direction:column;gap:16px;margin-bottom:28px}
.pf{display:flex;flex-direction:column;gap:4px}
.fl{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}
.fv{font-size:15px;color:#111827}
.act-col{display:flex;flex-direction:column;gap:10px}
.port-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;flex-wrap:wrap;gap:16px}
.st{font-size:20px;font-weight:700;color:#111827;margin:0}
.ss{font-size:14px;color:#6b7280;margin:6px 0 0;line-height:1.5}
.stats{display:flex;gap:16px}
.stat{background:#fff;border-radius:10px;padding:16px 20px;min-width:100px;text-align:center;border:1px solid #e2e8f0}
.stat-v{font-size:24px;font-weight:800}.stat-l{font-size:11px;font-weight:600;color:#6b7280;text-transform:uppercase;margin-top:4px}
.tabs{display:flex;gap:0;margin-bottom:16px;border-bottom:2px solid #e2e8f0}
.tab{padding:10px 20px;font-size:14px;background:none;border:none;cursor:pointer;font-family:inherit;margin-bottom:-2px}
.tab-a{font-weight:600;border-bottom:2px solid #0d4f8b;color:#0d4f8b}
.tab-i{font-weight:500;border-bottom:2px solid transparent;color:#6b7280}
.flts{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.chip{padding:5px 14px;font-size:13px;border-radius:20px;cursor:pointer;font-family:inherit;border:none}
.chip-a{font-weight:600;background:#0d4f8b;color:#fff}
.chip-i{font-weight:500;background:#f1f5f9;color:#475569;border:1px solid #cbd5e1}
.tc{background:#fff;border-radius:10px;border:1px solid #e2e8f0;overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:10px 14px;font-size:11px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;background:#f8fafc;border-bottom:1px solid #e2e8f0}
td{padding:10px 14px;font-size:14px;color:#1e293b;border-bottom:1px solid #f1f5f9}
.tr-e{background:#fff}.tr-o{background:#fafbfc}
.empty{padding:32px;text-align:center;color:#9ca3af;font-size:14px}
.ctag{display:inline-block;padding:2px 8px;background:#eff6ff;color:#1d4ed8;border-radius:4px;font-size:12px;font-weight:600;white-space:nowrap}
.pa{display:flex;gap:12px;margin-top:24px;flex-wrap:wrap}
.fg{margin-bottom:20px}.fm{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
.fr{display:flex;gap:16px}.fa{display:flex;gap:12px;margin-top:8px}
.suc{width:64px;height:64px;border-radius:50%;background:#dcfce7;color:#16a34a;display:inline-flex;align-items:center;justify-content:center;font-size:32px;font-weight:700}
.em-hi{font-size:18px;font-weight:600;color:#0d6efd;margin:16px 0}
.exp-sec{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:20px 24px;margin-bottom:20px}
.exp-hdr{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;color:#1e293b;margin-bottom:16px}
.cb-l{display:flex;align-items:center;gap:10px;cursor:pointer;margin-top:-8px;margin-bottom:8px}
.cb{width:18px;height:18px;accent-color:#0d4f8b;cursor:pointer}
.cb-t{font-size:14px;font-weight:500;color:#374151}
.vig-note{padding:10px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;color:#166534;font-size:13px;line-height:1.5;margin-bottom:8px}
.vig-badge{display:inline-block;padding:2px 10px;background:#dcfce7;color:#166534;border-radius:12px;font-size:12px;font-weight:600}
.new-user-sec{background:#f0f9ff;border:1px solid #bae6fd;border-radius:10px;padding:20px 24px;margin-bottom:20px}
.new-user-hdr{display:flex;align-items:center;gap:8px;font-size:15px;font-weight:600;color:#0369a1;margin-bottom:16px}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px}
.modal{background:#fff;border-radius:12px;padding:32px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.flag-btn{background:none;border:none;cursor:pointer;font-size:16px;opacity:.4;transition:opacity .2s;padding:2px 6px;border-radius:4px}
.flag-btn:hover{opacity:1;background:#fef2f2}
.flagged{background:#fef2f2;border-left:3px solid #f87171}
.loading-spin{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){
  .login-card{padding:32px 24px}
  .port-h{flex-direction:column}.stats{flex-wrap:wrap}
  .fr{flex-direction:column}
  .cnt{padding:20px 16px}
  .card{padding:24px 20px}
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef}=React;

// ‚ïê‚ïê‚ïê FRIENDLY NAMES ‚ïê‚ïê‚ïê
const CL={pub_paper:"Publicaci√≥n en revista indexada",pub_libro:"Libro o cap√≠tulo de libro",pub_caso_editorial:"Caso en editorial reconocida",pub_pedagogica:"Publicaci√≥n pedag√≥gica",conf_ext:"Presentaci√≥n en conferencia",editor_revista:"Editor / comit√© editorial",peer_review:"Revisi√≥n de manuscrito",working_paper:"Working paper",proy_comp:"Proyecto adjudicado competitivamente",movilidad_inv:"Pasant√≠a de investigaci√≥n",cargo_academico:"Cargo de gesti√≥n acad√©mica",sup_tesis:"Supervisi√≥n de tesis",material_ensenanza:"Material de ense√±anza",proy_innov_doc:"Proyecto de innovaci√≥n docente",perfeccion_acad:"Perfeccionamiento acad√©mico",coord_multisede:"Coordinaci√≥n multisede",part_comite:"Participaci√≥n en comit√©",movilidad_acad:"Movilidad acad√©mica",consultoria_alta:"Consultor√≠a",puesto_directorio:"Directorio / alta direcci√≥n",media_regular:"Contribuci√≥n en medios",extension_com:"Extensi√≥n y vinculaci√≥n",panelista_foro:"Panelista en foro / seminario",comite_tecnico:"Comit√© t√©cnico",clase_ed_ejec:"Clase en educaci√≥n ejecutiva",diseno_ed_ejec:"Dise√±o programa ed. ejecutiva",org_seminario:"Organizaci√≥n de seminario",podcast_blog:"Podcast / blog profesional",certificacion_prof:"Certificaci√≥n profesional",vcm_proyecto:"Proyecto VcM",asoc_profesional:"Asociaci√≥n profesional",mentor_equipos:"Mentor√≠a de equipos",vcm_alumni:"VcM alumni",colab_fen:"Investigaci√≥n colaborativa FEN",rediseno_curso:"Redise√±o de curso",diseno_programa:"Dise√±o de programa",caso_conf_repos:"Caso en conferencia/repositorio",caso_adoptado:"Caso adoptado por otra instituci√≥n",premio_academico:"Premio acad√©mico",patente_pi:"Patente / propiedad intelectual",policy_brief:"Policy brief",premio_sectorial:"Premio profesional",perito_arbitro:"Perito o √°rbitro",innovacion_docente:"Innovaci√≥n docente",material_docente:"Material docente publicado"};

const AG=[
  {label:"Investigaci√≥n ‚Äî Lista I",items:["pub_paper","pub_libro","pub_caso_editorial"]},
  {label:"Investigaci√≥n ‚Äî Lista II",items:["conf_ext","editor_revista","peer_review","working_paper","proy_comp","movilidad_inv","sup_tesis","policy_brief","caso_conf_repos","caso_adoptado","premio_academico","patente_pi","pub_pedagogica"]},
  {label:"Gesti√≥n y Docencia",items:["cargo_academico","part_comite","coord_multisede","material_ensenanza","rediseno_curso","diseno_programa","proy_innov_doc","mentor_equipos","movilidad_acad"]},
  {label:"Experiencia Profesional ‚Äî Lista III",items:["consultoria_alta","puesto_directorio","certificacion_prof","perfeccion_acad","asoc_profesional"]},
  {label:"Vinculaci√≥n y Debate P√∫blico ‚Äî Lista III",items:["media_regular","extension_com","panelista_foro","comite_tecnico","clase_ed_ejec","diseno_ed_ejec","org_seminario","podcast_blog","vcm_proyecto","premio_sectorial","perito_arbitro"]}
];

const DEST_EMAIL="c.troncosovalverde@uandresbello.edu";

// ‚ïê‚ïê‚ïê UTILITIES ‚ïê‚ïê‚ïê
function tc(s){return(s||'').toLowerCase().split(" ").map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ")}
function normRut(r){return(r||'').replace(/\./g,'').replace(/\s/g,'').toUpperCase().trim()}

function getDesc(ev){
  const c = ev.codigo;
  if (c==='pub_paper') return ev.titulo_articulo||ev.comentarios||'(sin descripci√≥n)';
  if (c==='pub_libro'||c==='pub_caso_editorial') return ev.titulo_capitulo||ev.titulo_libro||ev.comentarios||'(sin descripci√≥n)';
  if (c==='pub_pedagogica') return ev.titulo_articulo||ev.titulo_capitulo||ev.comentarios||'(sin descripci√≥n)';
  if (c==='conf_ext') return ev.titulo_ponencia||ev.comentarios||'(sin descripci√≥n)';
  if (c==='editor_revista') return ev.revista||ev.comentarios||'(sin descripci√≥n)';
  if (c==='peer_review') return ev.revista||ev.comentarios||'(sin descripci√≥n)';
  if (c==='working_paper') return ev.titulo_wp||ev.comentarios||'(sin descripci√≥n)';
  if (c==='proy_comp') return ev.titulo_proyecto||ev.comentarios||'(sin descripci√≥n)';
  if (c==='cargo_academico') return ev.cargo_gestion||ev.comentarios||'(sin descripci√≥n)';
  if (c==='sup_tesis') return ev.titulo_tesis||ev.comentarios||'(sin descripci√≥n)';
  if (c==='material_ensenanza'||c==='material_docente') return ev.descripcion_material||ev.nombre_curso||ev.comentarios||'(sin descripci√≥n)';
  if (c==='proy_innov_doc'||c==='innovacion_docente') return ev.nombre_proyecto_vcm||ev.comentarios||'(sin descripci√≥n)';
  if (c==='perfeccion_acad') return ev.nombre_programa||ev.comentarios||'(sin descripci√≥n)';
  if (c==='part_comite') return ev.nombre_comite||ev.comentarios||'(sin descripci√≥n)';
  if (c==='consultoria_alta') return ev.nombre_cliente||ev.comentarios||'(sin descripci√≥n)';
  if (c==='puesto_directorio') return ev.cargo_directorio||ev.comentarios||'(sin descripci√≥n)';
  if (c==='media_regular') return ev.titulo_nota||ev.comentarios||'(sin descripci√≥n)';
  if (c==='panelista_foro') return ev.titulo_ponencia||ev.comentarios||'(sin descripci√≥n)';
  if (c==='extension_com') return ev.nombre_evento||ev.comentarios||'(sin descripci√≥n)';
  if (c==='org_seminario') return ev.nombre_evento||ev.comentarios||'(sin descripci√≥n)';
  if (c==='clase_ed_ejec'||c==='diseno_ed_ejec') return ev.nombre_programa||ev.comentarios||'(sin descripci√≥n)';
  if (c==='comite_tecnico') return ev.nombre_comite||ev.comentarios||'(sin descripci√≥n)';
  if (c==='podcast_blog') return ev.nombre_podcast_blog||ev.comentarios||'(sin descripci√≥n)';
  if (c==='movilidad_inv'||c==='movilidad_acad') return ev.universidad||ev.comentarios||'(sin descripci√≥n)';
  if (c==='coord_multisede') return ev.nombre_curso||ev.comentarios||'(sin descripci√≥n)';
  if (c==='certificacion_prof') return ev.nombre_programa||ev.comentarios||'(sin descripci√≥n)';
  if (c==='mentor_equipos') return ev.nombre_proyecto_vcm||ev.comentarios||'(sin descripci√≥n)';
  if (c==='vcm_alumni') return ev.nombre_evento||ev.comentarios||'(sin descripci√≥n)';
  if (c==='premio_academico'||c==='premio_sectorial') return ev.nombre_evento||ev.comentarios||'(sin descripci√≥n)';
  if (c==='patente_pi') return ev.titulo_proyecto||ev.comentarios||'(sin descripci√≥n)';
  if (c==='policy_brief') return ev.titulo_wp||ev.titulo_articulo||ev.comentarios||'(sin descripci√≥n)';
  if (c==='rediseno_curso'||c==='diseno_programa') return ev.nombre_curso||ev.nombre_programa||ev.comentarios||'(sin descripci√≥n)';
  if (c==='caso_conf_repos'||c==='caso_adoptado') return ev.titulo_capitulo||ev.titulo_articulo||ev.comentarios||'(sin descripci√≥n)';
  return ev.comentarios||'(sin descripci√≥n)';
}

function getEvExtra(ev){
  const c = ev.codigo;
  const parts=[];
  // pub_paper: journal + real index + DOI
  if (c==='pub_paper') {
    if(ev.revista) parts.push(ev.revista);
    if(ev.indice && !['NO APLICA','N/A'].includes(ev.indice)){
      let s=ev.indice; if(ev.cuartil) s+=' '+ev.cuartil; parts.push('['+s+']');
    }
    if(ev.doi) parts.push('DOI: '+ev.doi);
  }
  // pub_libro: editorial only (indice/cuartil are fake SharePoint defaults)
  else if (c==='pub_libro'||c==='pub_caso_editorial') {
    if(ev.editorial) parts.push(ev.editorial);
  }
  // pub_pedagogica: journal + DOI
  else if (c==='pub_pedagogica') {
    if(ev.revista) parts.push(ev.revista); if(ev.doi) parts.push('DOI: '+ev.doi);
  }
  // working_paper: institution + series (NOT fake index)
  else if (c==='working_paper') {
    if(ev.institucion_serie) parts.push(ev.institucion_serie);
    if(ev.nombre_serie) parts.push(ev.nombre_serie);
  }
  // conf_ext: event name
  else if (c==='conf_ext') { if(ev.nombre_evento) parts.push(ev.nombre_evento); }
  // editor_revista: role
  else if (c==='editor_revista') { if(ev.rol_editorial) parts.push(ev.rol_editorial); }
  // sup_tesis: type ¬∑ program
  else if (c==='sup_tesis') {
    const tp=[]; if(ev.tipo_tesis) tp.push(ev.tipo_tesis); if(ev.programa_tesis) tp.push(ev.programa_tesis);
    if(tp.length) parts.push(tp.join(' ¬∑ '));
  }
  // proy_comp: agency
  else if (c==='proy_comp') { if(ev.agencia) parts.push(ev.agencia); }
  // consultoria_alta: project name
  else if (c==='consultoria_alta') { if(ev.nombre_proyecto_vcm) parts.push(ev.nombre_proyecto_vcm); }
  // puesto_directorio: organization + type
  else if (c==='puesto_directorio') {
    if(ev.nombre_cliente) parts.push(ev.nombre_cliente); if(ev.tipo_directorio) parts.push(ev.tipo_directorio);
  }
  // media_regular: outlet
  else if (c==='media_regular') { if(ev.nombre_medio) parts.push(ev.nombre_medio); }
  // panelista_foro: organizer
  else if (c==='panelista_foro') { if(ev.organizador_ponencia) parts.push(ev.organizador_ponencia); }
  // extension_com: organizer
  else if (c==='extension_com') { if(ev.organizador_extension) parts.push(ev.organizador_extension); }
  // org_seminario: type
  else if (c==='org_seminario') { if(ev.tipo_seminario) parts.push(ev.tipo_seminario); }
  // clase_ed_ejec: institution + module
  else if (c==='clase_ed_ejec') {
    if(ev.institucion_ed_ejecutiva) parts.push(ev.institucion_ed_ejecutiva);
    if(ev.modulo_ed_ejecutiva) parts.push(ev.modulo_ed_ejecutiva);
  }
  // perfeccion_acad: university + type
  else if (c==='perfeccion_acad') {
    if(ev.universidad) parts.push(ev.universidad); if(ev.tipo_perfeccionamiento) parts.push(ev.tipo_perfeccionamiento);
  }
  // comite_tecnico: convocante
  else if (c==='comite_tecnico') { if(ev.convocante_comite) parts.push(ev.convocante_comite); }
  // part_comite: role
  else if (c==='part_comite') { if(ev.rol_comite) parts.push(ev.rol_comite); }
  // movilidad: country
  else if (c==='movilidad_inv'||c==='movilidad_acad') { if(ev.pais_evento) parts.push(ev.pais_evento); }
  // coord_multisede: sedes
  else if (c==='coord_multisede') { if(ev.sedes) parts.push(ev.sedes); }
  // podcast_blog: platform
  else if (c==='podcast_blog') { if(ev.plataforma) parts.push(ev.plataforma); }
  // cargo_academico: leader
  else if (c==='cargo_academico') { if(ev.lider_academico&&ev.lider_academico.toLowerCase()==='s√≠') parts.push('L√≠der acad√©mico'); }
  // material_ensenanza: type
  else if (c==='material_ensenanza'||c==='material_docente') { if(ev.tipo_material) parts.push(ev.tipo_material); }
  return parts.join(' ‚Äî ');
}

function getCat(ev){
  for(const g of AG){
    if(g.items.includes(ev.codigo)) return g.label.replace(/ ‚Äî Lista [IV]+/,'');
  }
  return 'Otro';
}

function downloadBlob(content,filename,type){
  const blob=new Blob([content],{type});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
}

function downloadCSV(rows,filename){
  const csv=rows.map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(",")).join("\n");
  downloadBlob("\uFEFF"+csv,filename,"text/csv;charset=utf-8");
}

function sendMailto(subject,body){
  window.open(`mailto:${DEST_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`,"_blank");
}

// ‚ïê‚ïê‚ïê DATA PROCESSING ‚ïê‚ïê‚ïê
// Loads portafolio_data.json (exported by admin app) and builds per-RUT lookup
function processData(raw){
  const db={};
  const acadMap={};
  (raw.academicos||[]).forEach(a=>{acadMap[a.rut]=a;});
  // Group evidencias and exp by rut
  const evByRut={};const expByRut={};
  (raw.evidencias||[]).forEach(e=>{
    if(!evByRut[e.rut]) evByRut[e.rut]=[];
    evByRut[e.rut].push(e);
  });
  (raw.exp_laboral||[]).forEach(e=>{
    if(!expByRut[e.rut]) expByRut[e.rut]=[];
    expByRut[e.rut].push(e);
  });
  // Build per-academic entry
  Object.keys(acadMap).forEach(rut=>{
    const a=acadMap[rut];
    const evs=(evByRut[rut]||[]).map(e=>({
      ...e,
      _code:e.codigo,
      _cat:getCat(e),
      _year:e.anio_publicacion||e.anio||'',
      _desc:getDesc(e),
      _extra:getEvExtra(e),
    }));
    const exps=(expByRut[rut]||[]).map(e=>({
      cargo:e.cargo||'',
      organizacion:e.organizacion||'',
      inicio:e.anio_inicio||'',
      fin:e.anio_fin||'',
    }));
    db[rut]={
      name:a.nombre||'',
      email:a.email||'',
      grado:a.grado||'',
      gradoDetalle:a.grado_detalle||'',
      unidad:a.unidad||'',
      contrato:a.planta||'',
      evidencias:evs,
      expLaboral:exps,
    };
  });
  return db;
}

// ‚ïê‚ïê‚ïê COMPONENTS ‚ïê‚ïê‚ïê
function Header({email}){
  return <div className="hdr"><div className="hdr-in">
    <div style={{display:"flex",alignItems:"center",gap:14}}>
      <span className="hdr-t">Portafolio Acad√©mico ¬∑ FEN-UNAB</span>
    </div><span className="hdr-u">{email||""}</span>
  </div></div>;
}

function ReportModal({item,isExp,onClose,onSubmit}){
  const[msg,setMsg]=useState("");
  return <div className="modal-bg" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
    <h3 style={{fontSize:18,fontWeight:700,color:"#111827",marginBottom:8}}>Reportar error en {isExp?"experiencia laboral":"evidencia"}</h3>
    <div style={{padding:"12px 16px",background:"#f8fafc",borderRadius:8,marginBottom:16,fontSize:13,lineHeight:1.5}}>
      {isExp?<><strong>{item.cargo||"(sin cargo)"}</strong> ‚Äî {item.organizacion}{item.inicio?` (${item.inicio}‚Äì${item.fin==="vigente"?"presente":item.fin})`:""}</>
      :<><strong>{CL[item._code]||item._code}</strong>{item._year?` (${item._year})`:""}<br/>{item._desc||"(sin descripci√≥n)"}</>}
    </div>
    <div className="fg"><label className="fm">¬øQu√© error detect√≥? *</label>
      <textarea className="ta" value={msg} onChange={e=>setMsg(e.target.value)} rows={3}
        placeholder={isExp?"Ej: El cargo es incorrecto / Las fechas no corresponden":"Ej: El t√≠tulo est√° incompleto / Falta el nombre de la revista / El a√±o es incorrecto"}/></div>
    <div style={{display:"flex",gap:12}}>
      <button className="btn-p" style={{maxWidth:200}} disabled={!msg.trim()} onClick={()=>onSubmit(msg)}>Enviar reporte</button>
      <button className="btn-s" style={{maxWidth:150}} onClick={onClose}>Cancelar</button>
    </div>
  </div></div>;
}

// ‚ïê‚ïê‚ïê SCREEN: LOGIN ‚ïê‚ïê‚ïê
function ScreenLogin({db,onSearch,onNewUser}){
  const[rut,setRut]=useState("");const[err,setErr]=useState("");const[loading,setLoading]=useState(false);
  const ref=useRef(null);useEffect(()=>{ref.current?.focus()},[]);
  const go=()=>{
    const c=normRut(rut.trim());if(!c||c.length<7){setErr("Ingrese un RUT v√°lido.");return}
    setLoading(true);setErr("");
    setTimeout(()=>{
      const d=db[c];
      if(!d){setErr("NOT_FOUND");setLoading(false);return}
      onSearch(c,d);setLoading(false);
    },400);
  };
  const isNF=err==="NOT_FOUND";
  return <div className="login-bg"><div className="login-card">
    <h1>Portafolio Acad√©mico</h1>
    <p className="sub">Facultad de Econom√≠a y Negocios ¬∑ UNAB<br/>Ingrese su RUT para acceder a su informaci√≥n y reportar actividades.</p>
    <div className="ig"><label>RUT (con gui√≥n)</label>
      <input ref={ref} className="input" value={rut} onChange={e=>{setRut(e.target.value);setErr("")}} onKeyDown={e=>e.key==="Enter"&&go()} placeholder="12345678-9"/>
    </div>
    {err&&!isNF&&<div className="err">{err}</div>}
    {isNF&&<div style={{padding:"16px",background:"#fffbeb",border:"1px solid #fbbf24",borderRadius:8,marginBottom:16}}>
      <p style={{fontSize:14,fontWeight:600,color:"#92400e",marginBottom:8}}>RUT no encontrado en nuestros registros.</p>
      <p style={{fontSize:13,color:"#92400e",lineHeight:1.5,marginBottom:12}}>Si usted es acad√©mico FEN-UNAB, contacte a la Direcci√≥n de Aseguramiento de la Calidad.</p>
      <button className="btn-warn" onClick={()=>onNewUser(rut.trim())}>Registrarme como nuevo acad√©mico</button>
    </div>}
    <button className="btn-p" onClick={go} disabled={loading}>{loading?"Buscando‚Ä¶":"Ingresar"}</button>
    <p className="foot">Acceso exclusivo para acad√©micos FEN-UNAB ¬∑ Proceso AACSB</p>
  </div></div>;
}

// ‚ïê‚ïê‚ïê SCREEN: NEW USER ‚ïê‚ïê‚ïê
function ScreenNewUser({rut,onCancel}){
  const[name,setName]=useState("");const[email,setEmail]=useState("");const[saved,setSaved]=useState(false);
  const ok=name.trim()&&email.trim();
  const save=()=>{
    if(!ok)return;
    sendMailto(`[Portafolio FEN] Nuevo acad√©mico: ${rut}`,
      `Estimado equipo,\n\nSolicito mi incorporaci√≥n al Portafolio Acad√©mico.\n\nRUT: ${rut}\nNombre: ${name.trim()}\nEmail: ${email.trim()}\n\nSaludos.`);
    setSaved(true);
  };
  if(saved)return <div className="main"><Header email=""/><div className="cnt"><div className="card card-c">
    <div className="suc">‚úì</div>
    <h2 className="st" style={{marginTop:16}}>Solicitud enviada</h2>
    <p className="ss">Se abri√≥ su correo con los datos pre-llenados. Env√≠elo para completar el registro.</p>
    <button className="btn-o" style={{marginTop:24}} onClick={onCancel}>Volver al inicio</button>
  </div></div></div>;
  return <div className="main"><Header email=""/><div className="cnt"><div className="card">
    <h2 className="st">Registro de nuevo acad√©mico</h2>
    <p className="ss" style={{marginBottom:24}}>Su RUT <strong>{rut}</strong> no est√° en nuestros registros. Complete los datos b√°sicos.</p>
    <div className="new-user-sec">
      <div className="new-user-hdr"><span>üìã</span><span>Datos b√°sicos</span></div>
      <div className="fg"><label className="fm">Nombre completo *</label><input className="input" value={name} onChange={e=>setName(e.target.value)} placeholder="Nombre Apellido Apellido"/></div>
      <div className="fg"><label className="fm">Email institucional *</label><input className="input" value={email} onChange={e=>setEmail(e.target.value)} placeholder="nombre@uandresbello.edu"/></div>
    </div>
    <div className="fa">
      <button className="btn-p" style={{maxWidth:300}} onClick={save} disabled={!ok}>Enviar solicitud</button>
      <button className="btn-s" style={{maxWidth:150}} onClick={onCancel}>Cancelar</button>
    </div>
  </div></div></div>;
}

// ‚ïê‚ïê‚ïê SCREEN: PROFILE CONFIRMATION ‚ïê‚ïê‚ïê
function ScreenProfile({data,onContinue,onError}){
  const ini=data.name.split(" ").map(n=>(n||'X')[0]).slice(0,2).join("");
  return <div className="main"><Header email={data.email}/>
    <div className="cnt"><div className="card">
      <div className="ph"><div className="av">{ini}</div><div><h2 className="pn">{tc(data.name)}</h2><p className="pe">{data.email}</p></div></div>
      <div className="pg">
        <div className="pf"><span className="fl">Unidad</span><span className="fv">{data.unidad||"(sin asignar)"}</span></div>
        <div className="pf"><span className="fl">Contrato</span><span className="fv">{data.contrato||"(sin asignar)"}</span></div>
        <div className="pf"><span className="fl">Grado</span><span className="fv">{data.grado}{data.gradoDetalle?' ‚Äî '+data.gradoDetalle:''}{!data.grado&&!data.gradoDetalle?'(sin asignar)':''}</span></div>
      </div>
      <div className="act-col">
        <button className="btn-p" onClick={onContinue}>S√≠, mis datos son correctos ‚Üí Continuar</button>
        <button className="btn-s" onClick={onError}>Hay un error en mis datos</button>
      </div>
    </div></div>
  </div>;
}

// ‚ïê‚ïê‚ïê SCREEN: PORTFOLIO (main read-only view) ‚ïê‚ïê‚ïê
function ScreenPortfolio({data,rut,onAdd,onDoneSent,onDoneEmpty,pending,reports,setReports}){
  const[tab,setTab]=useState("ev");const[flt,setFlt]=useState("all");
  const[reportIdx,setReportIdx]=useState(null);
  const cats=[...new Set(data.evidencias.map(e=>e._cat))];
  const filtered=flt==="all"?data.evidencias:data.evidencias.filter(e=>e._cat===flt);
  const hasPending=pending.length>0;
  const hasReports=reports.length>0;
  const hasAnything=hasPending||hasReports;

  const handleReport=(msg)=>{
    const isExp=String(reportIdx).startsWith("exp_");
    const item=isExp?data.expLaboral[parseInt(String(reportIdx).split("_")[1])]:data.evidencias[reportIdx];
    setReports(prev=>[...prev,{idx:reportIdx,item,isExp,msg}]);
    setReportIdx(null);
  };

  const getOrigIdx=(ev)=>data.evidencias.indexOf(ev);

  // ‚îÄ‚îÄ FINALIZE: generate JSON (for admin app) + CSV (backup) + mailto ‚îÄ‚îÄ
  const sendAll=()=>{
    const ts=new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
    const now=new Date().toISOString();

    // 1. Build JSON importable by admin app
    const nuevas_ev=pending.filter(p=>!p.isExp).map(p=>{
      const ev={id_evidencia:'PORTAL_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        rut,codigo:p.actType,anio:p.year||'',titulo_articulo:'',titulo_ponencia:'',cargo_gestion:'',
        titulo_nota:'',nombre_evento:'',titulo_wp:'',titulo_tesis:'',nombre_comite:'',cargo_directorio:'',
        nombre_programa:'',nombre_cliente:'',nombre_medio:'',titulo_libro:'',titulo_proyecto:'',
        revista:'',doi:'',indice:'',cuartil:'',url:p.evidenceLink||'',comentarios:p.comments||'',
        estado:'pendiente',fecha_envio:now};
      // Put description in right field
      const c=p.actType;
      if(['pub_paper','pub_libro'].includes(c))ev.titulo_articulo=p.description;
      else if(c==='conf_ext')ev.titulo_ponencia=p.description;
      else if(['cargo_academico','part_comite'].includes(c))ev.cargo_gestion=p.description;
      else if(c==='media_regular')ev.titulo_nota=p.description;
      else if(c==='puesto_directorio')ev.cargo_directorio=p.description;
      else if(c==='sup_tesis')ev.titulo_tesis=p.description;
      else if(['consultoria_alta','vcm_proyecto'].includes(c))ev.nombre_cliente=p.description;
      else if(c==='proy_comp')ev.titulo_proyecto=p.description;
      else if(['panelista_foro','extension_com','org_seminario'].includes(c))ev.nombre_evento=p.description;
      else ev.comentarios=p.description+(p.comments?' | '+p.comments:'');
      return ev;
    });
    const nuevas_exp=pending.filter(p=>p.isExp).map(p=>({
      rut,cargo:p.expCargo,organizacion:p.expEmpresa,
      anio_inicio:p.expInicio,anio_fin:p.expVigente?'vigente':(p.expFin||''),
      notas:'Agregado por profesor via portal',fecha_envio:now
    }));
    const errores_reportados=reports.map(r=>({
      tipo:r.isExp?'exp_laboral':'evidencia',
      id_evidencia:r.isExp?null:(r.item.id_evidencia||null),
      idx:r.isExp?parseInt(String(r.idx).split("_")[1]):null,
      cargo_ref:r.isExp?(r.item.cargo||''):null,
      codigo_ref:r.isExp?null:(r.item._code||''),
      descripcion_ref:r.isExp?null:(r.item._desc||''),
      descripcion_error:r.msg,
      fecha:now,
    }));

    const jsonPayload={
      _formato:'cambios_portafolio_fen_v1',
      rut,nombre:data.name,fecha_generacion:now,
      nuevas_evidencias:nuevas_ev,
      nuevas_exp:nuevas_exp,
      modificaciones_ev:[],modificaciones_exp:[],
      errores_reportados,
    };
    downloadBlob(JSON.stringify(jsonPayload,null,2),
      `cambios_${rut.replace(/[^0-9kK]/g,'')}_${ts}.json`,'application/json');

    // 2. Build CSV backup
    const csvRows=[["RUT","Nombre","Tipo","Actividad","A√±o","Descripci√≥n","Enlace","Comentario","Error"]];
    pending.forEach(p=>{
      csvRows.push([rut,data.name,p.isExp?"NUEVA_EXP":"NUEVA_ACTIVIDAD",
        p.isExp?`${p.expCargo} ‚Äî ${p.expEmpresa}`:(CL[p.actType]||p.actType),
        p.isExp?p.expInicio:p.year,p.isExp?'':(p.description||''),p.evidenceLink||'',p.comments||'','']);
    });
    reports.forEach(r=>{
      csvRows.push([rut,data.name,"ERROR",
        r.isExp?`Exp: ${r.item.cargo}`:(CL[r.item._code]||r.item._code),
        r.isExp?r.item.inicio:(r.item._year||''),
        r.isExp?r.item.organizacion:(r.item._desc||''),'','',r.msg]);
    });
    downloadCSV(csvRows,`portafolio_${rut.replace(/[^0-9kK]/g,'')}_${ts}.csv`);

    // 3. Open mailto
    let body=`Estimado equipo,\n\nAdjunto novedades de mi portafolio acad√©mico.\n\nRUT: ${rut}\nNombre: ${data.name}\n\n`;
    if(hasPending){
      body+=`NUEVAS ACTIVIDADES (${pending.length})\n${'‚ïê'.repeat(30)}\n\n`;
      pending.forEach((p,i)=>{
        body+=`${i+1}. `;
        if(p.isExp) body+=`Exp. Laboral: ${p.expCargo} ‚Äî ${p.expEmpresa} (${p.expInicio}‚Äì${p.expVigente?"Vigente":(p.expFin||"?")})\n`;
        else body+=`${CL[p.actType]||p.actType}${p.year?` (${p.year})`:""}: ${p.description}\n`;
        if(p.evidenceLink) body+=`   Evidencia: ${p.evidenceLink}\n`;
        if(p.comments) body+=`   Comentario: ${p.comments}\n`;
        body+='\n';
      });
    }
    if(hasReports){
      body+=`ERRORES REPORTADOS (${reports.length})\n${'‚ïê'.repeat(30)}\n\n`;
      reports.forEach((r,i)=>{
        body+=`${i+1}. `;
        if(r.isExp) body+=`Exp. Laboral: ${r.item.cargo||"sin cargo"} ‚Äî ${r.item.organizacion}\n`;
        else body+=`${CL[r.item._code]||r.item._code}${r.item._year?` (${r.item._year})`:""}: ${r.item._desc||"sin desc."}\n`;
        body+=`   Error: ${r.msg}\n\n`;
      });
    }
    body+=`Se adjuntan:\n- cambios_*.json (para importar en la app de gesti√≥n)\n- portafolio_*.csv (respaldo legible)\n\nSi tiene documentos adicionales (certificados, PDFs), adj√∫ntelos al correo.\n\nSaludos.`;
    const nA=pending.length;const nE=reports.length;
    const parts=[];
    if(nA)parts.push(`${nA} actividad${nA>1?"es":""}`);
    if(nE)parts.push(`${nE} error${nE>1?"es":""}`);
    sendMailto(`[Portafolio FEN] ${parts.join(" + ")} ‚Äî ${rut}`,body);
    onDoneSent();
  };

  return <div className="main"><Header email={data.email}/>
    <div className="cnt">
      <div className="port-h"><div>
        <h2 className="st">Portafolio de {tc(data.name)}</h2>
        <p className="ss">Revise su informaci√≥n. Si detecta un error, use el bot√≥n ‚öë junto a cada registro.</p>
      </div>
      <div className="stats">
        <div className="stat"><div className="stat-v" style={{color:"#0d6efd"}}>{data.evidencias.length}</div><div className="stat-l">Evidencias</div></div>
        <div className="stat"><div className="stat-v" style={{color:"#6f42c1"}}>{data.expLaboral.length}</div><div className="stat-l">Exp. Laboral</div></div>
      </div></div>

      {hasPending&&<div style={{padding:"12px 16px",background:"#eff6ff",border:"1px solid #bfdbfe",borderRadius:8,marginBottom:12}}>
        <span style={{fontSize:13,color:"#1e40af"}}><strong>{pending.length}</strong> actividad{pending.length>1?"es":""} nueva{pending.length>1?"s":""} pendiente{pending.length>1?"s":""} de env√≠o</span>
        <div style={{marginTop:8,fontSize:12,color:"#3b82f6"}}>
          {pending.map((p,i)=><div key={i} style={{padding:"2px 0"}}>
            ‚Ä¢ {p.isExp?`Exp. laboral: ${p.expCargo} ‚Äî ${p.expEmpresa}`:`${CL[p.actType]||p.actType}${p.year?` (${p.year})`:""}`}
          </div>)}
        </div>
      </div>}

      {hasReports&&<div style={{padding:"12px 16px",background:"#fef2f2",border:"1px solid #fecaca",borderRadius:8,marginBottom:12}}>
        <span style={{fontSize:13,color:"#991b1b"}}><strong>{reports.length}</strong> error{reports.length>1?"es":""} reportado{reports.length>1?"s":""}</span>
      </div>}

      <div className="tabs">
        <button className={`tab ${tab==="ev"?"tab-a":"tab-i"}`} onClick={()=>setTab("ev")}>Evidencias ({data.evidencias.length})</button>
        <button className={`tab ${tab==="ex"?"tab-a":"tab-i"}`} onClick={()=>setTab("ex")}>Experiencia Laboral ({data.expLaboral.length})</button>
      </div>

      {tab==="ev"&&<><div className="flts">
        <button className={`chip ${flt==="all"?"chip-a":"chip-i"}`} onClick={()=>setFlt("all")}>Todas</button>
        {cats.map(c=><button key={c} className={`chip ${flt===c?"chip-a":"chip-i"}`} onClick={()=>setFlt(c)}>{c}</button>)}
      </div>
      <div className="tc"><table><thead><tr><th style={{width:"30px"}}></th><th>Tipo</th><th>A√±o</th><th style={{width:"55%"}}>Descripci√≥n</th></tr></thead><tbody>
        {filtered.length===0&&<tr><td colSpan={4} className="empty">No hay registros en esta categor√≠a.</td></tr>}
        {filtered.map((ev,i)=>{
          const origIdx=getOrigIdx(ev);
          const isReported=reports.some(r=>r.idx===origIdx);
          return <tr key={i} className={`${i%2===0?"tr-e":"tr-o"} ${isReported?"flagged":""}`}>
            <td style={{textAlign:"center",padding:"6px"}}>
              <button className="flag-btn" title="Reportar error" onClick={()=>setReportIdx(origIdx)}
                style={isReported?{opacity:1,color:"#dc2626"}:{}}>‚öë</button>
            </td>
            <td><span className="ctag">{CL[ev._code]||ev._code}</span></td>
            <td style={{textAlign:"center",fontVariantNumeric:"tabular-nums",color:ev._year?"#1e293b":"#d1d5db"}}>{ev._year||""}</td>
            <td style={{fontSize:"13px"}}>{ev._desc||<span style={{color:"#d1d5db",fontStyle:"italic"}}>sin descripci√≥n</span>}
              {ev._extra&&<div style={{fontSize:11,color:"#6b7280",marginTop:2}}>{ev._extra}</div>}
            </td>
          </tr>;})}
      </tbody></table></div></>}

      {tab==="ex"&&<div className="tc"><table><thead><tr><th style={{width:"30px"}}></th><th>Cargo</th><th>Organizaci√≥n</th><th>Inicio</th><th>Fin</th></tr></thead><tbody>
        {data.expLaboral.length===0&&<tr><td colSpan={5} className="empty">No hay registros.</td></tr>}
        {data.expLaboral.map((ex,i)=>{
          const isReported=reports.some(r=>r.idx===`exp_${i}`);
          return <tr key={i} className={`${i%2===0?"tr-e":"tr-o"} ${isReported?"flagged":""}`}>
            <td style={{textAlign:"center",padding:"6px"}}>
              <button className="flag-btn" title="Reportar error" onClick={()=>setReportIdx(`exp_${i}`)}
                style={isReported?{opacity:1,color:"#dc2626"}:{}}>‚öë</button>
            </td>
            <td>{ex.cargo||<span style={{color:"#d1d5db",fontStyle:"italic"}}>sin cargo</span>}</td>
            <td>{ex.organizacion}</td>
            <td style={{textAlign:"center"}}>{ex.inicio}</td>
            <td style={{textAlign:"center"}}>{ex.fin==="vigente"||ex.fin==="0"?<span className="vig-badge">Vigente</span>:ex.fin}</td>
          </tr>;})}
      </tbody></table></div>}

      <div className="pa">
        <button className="btn-p" style={{maxWidth:400}} onClick={onAdd}>+ Agregar nueva actividad o experiencia</button>
        {hasAnything
          ?<button className="btn-p" style={{maxWidth:400,background:"#16a34a"}} onClick={sendAll}>Finalizar y enviar ({pending.length+reports.length} item{pending.length+reports.length>1?"s":""})</button>
          :<button className="btn-o" onClick={()=>onDoneEmpty()}>No tengo nada que agregar ‚Üí Finalizar</button>}
      </div>
    </div>
    {reportIdx!==null&&(()=>{
      const isExp=String(reportIdx).startsWith("exp_");
      const item=isExp?data.expLaboral[parseInt(String(reportIdx).split("_")[1])]:data.evidencias[reportIdx];
      return <ReportModal item={item} isExp={isExp} onClose={()=>setReportIdx(null)} onSubmit={handleReport}/>;
    })()}
  </div>;
}

// ‚ïê‚ïê‚ïê SCREEN: ADD ACTIVITY ‚ïê‚ïê‚ïê
function ScreenAdd({data,rut,onSave,onCancel}){
  const[at,setAt]=useState("");const[yr,setYr]=useState("");const[desc,setDesc]=useState("");const[cm,setCm]=useState("");
  const[ec,setEc]=useState("");const[ee,setEe]=useState("");const[ei,setEi]=useState("");const[ef,setEf]=useState("");const[ev,setEv]=useState(false);
  const[link,setLink]=useState("");
  const isExp=at==="exp_laboral";
  const ok=isExp?(ec&&ee&&ei):(at&&desc);
  const save=()=>{if(!ok)return;onSave({actType:at,year:yr,description:desc,comments:cm,isExp,expCargo:ec,expEmpresa:ee,expInicio:ei,expFin:ef,expVigente:ev,evidenceLink:link});};

  return <div className="main"><Header email={data.email}/><div className="cnt"><div className="card">
    <h2 className="st">Agregar nueva actividad</h2>
    <p className="ss" style={{marginBottom:24}}>Complete los campos. Puede agregar varias actividades antes de enviar.</p>
    <div className="fg"><label className="fm">Tipo de actividad *</label>
      <select value={at} onChange={e=>setAt(e.target.value)} className="sel">
        <option value="">Seleccione...</option>
        {AG.map(g=><optgroup key={g.label} label={g.label}>{g.items.map(c=><option key={c} value={c}>{CL[c]}</option>)}</optgroup>)}
        <optgroup label="Experiencia Laboral"><option value="exp_laboral">Nueva experiencia laboral</option></optgroup>
      </select>
    </div>

    {isExp&&<div className="exp-sec">
      <div className="exp-hdr"><span>üíº</span><span>Datos de la experiencia laboral</span></div>
      <div className="fg"><label className="fm">Cargo o posici√≥n *</label><input className="input" value={ec} onChange={e=>setEc(e.target.value)} placeholder="Ej: Gerente de Finanzas"/></div>
      <div className="fg"><label className="fm">Organizaci√≥n *</label><input className="input" value={ee} onChange={e=>setEe(e.target.value)} placeholder="Ej: Banco de Chile"/></div>
      <div className="fr">
        <div className="fg" style={{flex:1}}><label className="fm">A√±o inicio *</label><input className="input" value={ei} onChange={e=>setEi(e.target.value)} placeholder="2018"/></div>
        <div className="fg" style={{flex:1}}><label className="fm">A√±o fin</label><input className="input" value={ef} onChange={e=>setEf(e.target.value)} placeholder="2024" disabled={ev} style={{opacity:ev?.4:1,backgroundColor:ev?"#f3f4f6":"#fff"}}/></div>
      </div>
      <label className="cb-l"><input type="checkbox" className="cb" checked={ev} onChange={e=>{setEv(e.target.checked);if(e.target.checked)setEf("")}}/><span className="cb-t">Cargo vigente (a la fecha)</span></label>
      {ev&&<div className="vig-note">Este cargo ser√° marcado como vigente.</div>}
    </div>}

    {!isExp&&at&&<>
      <div className="fg" style={{maxWidth:200}}><label className="fm">A√±o</label><input className="input" value={yr} onChange={e=>setYr(e.target.value)} placeholder="2024"/></div>
      <div className="fg"><label className="fm">Descripci√≥n *</label><textarea className="ta" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Describa la actividad con el mayor detalle posible" rows={4}/></div>
    </>}
    {at&&<>
      <div className="fg">
        <label className="fm">Enlace a evidencia (opcional)</label>
        <input className="input" value={link} onChange={e=>setLink(e.target.value)} placeholder="DOI, URL o enlace a Google Drive/OneDrive"/>
        <span style={{fontSize:12,color:"#6b7280",marginTop:4,display:"block"}}>Si tiene archivos PDF u otros documentos, adj√∫ntelos al correo al momento de enviar.</span>
      </div>
      <div className="fg"><label className="fm">Comentarios adicionales (opcional)</label>
      <textarea className="ta" value={cm} onChange={e=>setCm(e.target.value)} placeholder="Cualquier informaci√≥n adicional" rows={2}/></div>
    </>}
    <div className="fa">
      <button className="btn-p" style={{maxWidth:300,opacity:ok?1:.5}} onClick={save} disabled={!ok}>Agregar</button>
      <button className="btn-s" style={{maxWidth:150}} onClick={onCancel}>Cancelar</button>
    </div>
  </div></div></div>;
}

// ‚ïê‚ïê‚ïê SCREEN: PROFILE ERROR ‚ïê‚ïê‚ïê
function ScreenError({onBack,onContinue}){
  return <div className="main"><Header email=""/><div className="cnt"><div className="card card-c">
    <div style={{fontSize:48,marginBottom:16}}>üìß</div>
    <h2 className="st">Solicitud de correcci√≥n</h2>
    <p className="ss">Para corregir datos base (nombre, grado, unidad), escriba a:</p>
    <p className="em-hi">{DEST_EMAIL}</p>
    <p className="ss">Indique su RUT, el dato a corregir y la informaci√≥n correcta.</p>
    <div style={{marginTop:24,display:"flex",gap:12,justifyContent:"center",flexWrap:"wrap"}}>
      <button className="btn-p" style={{maxWidth:300}} onClick={onContinue}>Continuar al portafolio ‚Üí</button>
      <button className="btn-o" onClick={onBack}>‚Üê Volver al inicio</button>
    </div>
  </div></div></div>;
}

// ‚ïê‚ïê‚ïê SCREEN: DONE ‚ïê‚ïê‚ïê
function ScreenDone({data,onBack}){
  return <div className="main"><Header email={data.email}/><div className="cnt"><div className="card card-c">
    <div className="suc">‚úì</div>
    <h2 className="st" style={{marginTop:16}}>¬°Gracias, {tc(data.name.split(" ")[0])}!</h2>
    <p className="ss">Se descargaron dos archivos y se abri√≥ su correo:</p>
    <p className="ss" style={{marginTop:8}}><strong>cambios_*.json</strong> ‚Üí para importar en la app de gesti√≥n<br/><strong>portafolio_*.csv</strong> ‚Üí respaldo legible</p>
    <p className="ss" style={{marginTop:8}}><strong>Adjunte ambos archivos y cualquier documento de evidencia al correo antes de enviarlo.</strong></p>
    <button className="btn-o" style={{marginTop:24}} onClick={onBack}>Volver al inicio</button>
  </div></div></div>;
}

function ScreenDoneEmpty({data,onBack}){
  return <div className="main"><Header email={data.email}/><div className="cnt"><div className="card card-c">
    <div className="suc">‚úì</div>
    <h2 className="st" style={{marginTop:16}}>¬°Gracias, {tc(data.name.split(" ")[0])}!</h2>
    <p className="ss">Su portafolio ha sido confirmado. Puede volver en cualquier momento.</p>
    <button className="btn-o" style={{marginTop:24}} onClick={onBack}>Volver al inicio</button>
  </div></div></div>;
}

// ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê
function App(){
  const[db,setDb]=useState(null);const[err,setErr]=useState("");
  const[scr,setScr]=useState("login");const[data,setData]=useState(null);const[rut,setRut]=useState("");
  const[pending,setPending]=useState([]);
  const[reports,setReports]=useState([]);

  useEffect(()=>{
    fetch("portafolio_data.json").then(r=>{if(!r.ok)throw new Error(r.status);return r.json()})
      .then(raw=>setDb(processData(raw)))
      .catch(e=>setErr("Error cargando datos. Verifique que portafolio_data.json est√© disponible."));
  },[]);

  if(err)return <div className="login-bg"><div className="login-card"><h1>Error</h1><div className="err" style={{marginTop:16}}>{err}</div></div></div>;
  if(!db)return <div className="login-bg"><div className="login-card" style={{textAlign:"center"}}><div className="loading-spin" style={{borderColor:"rgba(13,79,139,.3)",borderTopColor:"#0d4f8b",margin:"20px auto"}}></div><p className="sub">Cargando datos...</p></div></div>;

  const search=(r,d)=>{setRut(r);setData(d);setScr("profile")};
  const reset=()=>{setScr("login");setData(null);setRut("");setPending([]);setReports([])};
  const addActivity=(item)=>{setPending(prev=>[...prev,item]);setScr("portfolio")};

  switch(scr){
    case "login":return <ScreenLogin db={db} onSearch={search} onNewUser={(r)=>{setRut(r);setScr("newuser")}}/>;
    case "newuser":return <ScreenNewUser rut={rut} onCancel={reset}/>;
    case "profile":return <ScreenProfile data={data} onContinue={()=>setScr("portfolio")} onError={()=>setScr("error")}/>;
    case "portfolio":return <ScreenPortfolio data={data} rut={rut} pending={pending} reports={reports} setReports={setReports}
      onAdd={()=>setScr("add")} onDoneSent={()=>setScr("done")} onDoneEmpty={()=>setScr("doneEmpty")}/>;
    case "add":return <ScreenAdd data={data} rut={rut} onSave={addActivity} onCancel={()=>setScr("portfolio")}/>;
    case "error":return <ScreenError onBack={reset} onContinue={()=>setScr("portfolio")}/>;
    case "done":return <ScreenDone data={data} onBack={reset}/>;
    case "doneEmpty":return <ScreenDoneEmpty data={data} onBack={reset}/>;
    default:return <ScreenLogin db={db} onSearch={search} onNewUser={(r)=>{setRut(r);setScr("newuser")}}/>;
  }
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
