<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Portafolio Acad√©mico ¬∑ FEN-UNAB</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700&family=DM+Serif+Display&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
:root{--bg:#f5f3ef;--card:#fff;--border:#e5e0d8;--text:#2c2825;--text2:#6b6460;--accent:#1a5276;--accent2:#2980b9;--accent-light:#eaf2f8;--warm:#c0793c;--warm-light:#fdf6ee;--green:#1e8449;--green-light:#eafaf1;--red:#c0392b;--font:'DM Sans',-apple-system,system-ui,sans-serif;--font-display:'DM Serif Display',Georgia,serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6}
.header{background:var(--accent);color:#fff;padding:20px 0}
.header-inner{max-width:960px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between}
.header h1{font-family:var(--font-display);font-size:22px;font-weight:400;letter-spacing:.3px}
.header-sub{font-size:12px;opacity:.7;margin-top:2px}
.container{max-width:960px;margin:0 auto;padding:24px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:28px;margin-bottom:20px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.card-title{font-family:var(--font-display);font-size:20px;margin-bottom:16px;color:var(--accent)}
.login-box{max-width:480px;margin:60px auto;text-align:center}
.login-box .card{padding:40px}
.login-logo{font-family:var(--font-display);font-size:32px;color:var(--accent);margin-bottom:8px}
.login-desc{font-size:15px;color:var(--text2);margin-bottom:28px;line-height:1.7}
.input-group{text-align:left;margin-bottom:16px}
.input-group label{display:block;font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.input{width:100%;padding:12px 16px;border:1.5px solid var(--border);border-radius:8px;font-size:16px;font-family:var(--font);outline:none;transition:border .2s}
.input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(26,82,118,.1)}
.input-sm{padding:8px 12px;font-size:14px}
.sel{padding:8px 12px;border:1.5px solid var(--border);border-radius:6px;font-size:14px;font-family:var(--font);outline:none;background:#fff;cursor:pointer}
textarea.input{resize:vertical;min-height:60px}
.btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border-radius:8px;font-size:14px;font-weight:600;font-family:var(--font);cursor:pointer;border:none;transition:all .15s}
.btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#154360}
.btn-warm{background:var(--warm);color:#fff}.btn-warm:hover{background:#a06630}
.btn-outline{background:transparent;border:1.5px solid var(--border);color:var(--text)}.btn-outline:hover{background:var(--bg)}
.btn-sm{padding:8px 16px;font-size:13px}
.btn-block{width:100%;justify-content:center}
.btn:disabled{opacity:.5;cursor:not-allowed}
.banner{background:var(--warm-light);border:1.5px solid var(--warm);border-radius:10px;padding:20px 24px;margin-bottom:20px}
.banner-title{font-weight:700;font-size:14px;color:var(--warm);margin-bottom:6px;display:flex;align-items:center;gap:8px}
.banner-text{font-size:13px;color:#7d5a2f;line-height:1.7}
.banner-email{font-weight:700;color:var(--accent);font-size:14px}
.banner-critical{background:#fef3c7;border-color:#f59e0b}
.prof-name{font-family:var(--font-display);font-size:26px;color:var(--accent)}
.prof-meta{font-size:13px;color:var(--text2);margin-top:4px}
.prof-stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
.stat-pill{background:var(--accent-light);border:1px solid #c5d9e8;border-radius:8px;padding:10px 18px;text-align:center;min-width:100px}
.stat-pill-v{font-size:22px;font-weight:800;color:var(--accent)}.stat-pill-l{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-top:2px}
.tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:20px}
.tab{padding:10px 20px;font-size:14px;font-weight:600;color:var(--text2);cursor:pointer;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;background:none;font-family:var(--font)}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.ev-card{border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:8px;transition:box-shadow .15s}
.ev-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.ev-card.ev-new{border-color:var(--warm);background:var(--warm-light)}
.edit-panel{margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;background:#fffbeb;padding:12px;border-radius:8px;border:1px solid #fde68a}
.edit-panel .full{grid-column:1/-1}
.edit-panel label{font-size:11px;font-weight:600;color:#6b7280}
.add-form{background:var(--bg);border:1.5px dashed var(--border);border-radius:10px;padding:24px;margin-bottom:16px}
.form-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px;margin-bottom:16px}
.toast{position:fixed;bottom:24px;right:24px;background:var(--accent);color:#fff;padding:14px 24px;border-radius:10px;font-size:14px;font-weight:500;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,.2);animation:slideUp .3s}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.empty{padding:40px;text-align:center;color:var(--text2);font-size:14px}
.changes-bar{position:sticky;bottom:0;background:var(--accent);color:#fff;padding:14px 24px;border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:0 -4px 20px rgba(0,0,0,.15);z-index:50;margin:0 -24px;flex-wrap:wrap}
.pulse{width:10px;height:10px;border-radius:50%;background:#f39c12;animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.dean-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px}
.dean-stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.dean-stat-v{font-size:28px;font-weight:800}.dean-stat-l{font-size:10px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;margin-top:2px}
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:10px 12px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.4px;background:#fafaf8;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:1}
.tbl td{padding:10px 12px;border-bottom:1px solid #f5f3ef}.tbl tr:hover{background:#fafaf8}.tbl tr{cursor:pointer}
.scroll-table{max-height:600px;overflow-y:auto;border:1px solid var(--border);border-radius:8px}
@media(max-width:640px){.container{padding:16px}.card{padding:20px}.form-grid{grid-template-columns:1fr}.edit-panel{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useMemo}=React;
const CONTACT_EMAIL='c.troncosovalverde@uandresbello.edu';
const DEAN_PASS='fen2025';

const CATALOGO={pub_paper:'Art√≠culo en revista acad√©mica',pub_libro:'Libro o cap√≠tulo de libro',pub_caso_editorial:'Caso editorial',pub_pedagogica:'Publicaci√≥n pedag√≥gica',proy_comp:'Proyecto competitivo',movilidad_inv:'Movilidad investigativa',conf_ext:'Conferencia o ponencia',editor_revista:'Editor/Comit√© editorial',peer_review:'Peer review',working_paper:'Working paper',sup_tesis:'Supervisi√≥n de tesis',policy_brief:'Policy brief',caso_conf_repos:'Caso en conferencia/repositorio',caso_adoptado:'Caso adoptado por otra instituci√≥n',premio_academico:'Premio acad√©mico',patente_pi:'Patente o propiedad intelectual',consultoria_alta:'Consultor√≠a de alto nivel',clase_ed_ejec:'Clase en educaci√≥n ejecutiva',diseno_ed_ejec:'Dise√±o de programa ejecutivo',comite_tecnico:'Comit√© t√©cnico sectorial',puesto_directorio:'Puesto en directorio',asoc_profesional:'Asociaci√≥n profesional',vcm_proyecto:'Proyecto de vinculaci√≥n con el medio',media_regular:'Aparici√≥n en medios',podcast_blog:'Podcast, blog o columna digital',panelista_foro:'Panelista en foro/seminario',certificacion_prof:'Certificaci√≥n profesional',perfeccion_acad:'Perfeccionamiento acad√©mico',extension_com:'Extensi√≥n comunitaria',org_seminario:'Organizaci√≥n de seminario/workshop',premio_sectorial:'Premio profesional/sectorial',perito_arbitro:'Perito o √°rbitro',cargo_academico:'Cargo de gesti√≥n acad√©mica',part_comite:'Participaci√≥n en comit√© FEN',innovacion_docente:'Innovaci√≥n docente',material_docente:'Material docente publicado'};

const EDIT_FIELDS={pub_paper:['titulo_articulo','revista','doi','indice','cuartil','anio_publicacion','anio','url'],pub_libro:['titulo_libro','titulo_capitulo','editorial','anio','url'],pub_caso_editorial:['titulo_articulo','editorial','anio','url'],pub_pedagogica:['titulo_articulo','revista','doi','anio','url'],conf_ext:['titulo_ponencia','nombre_evento','pais_evento','tipo_conferencia','organizador_ponencia','tipo_ponencia','anio','url'],proy_comp:['titulo_proyecto','agencia','rol_proyecto','financiamiento','fecha_adjudicacion','anio','url'],working_paper:['titulo_wp','institucion_serie','nombre_serie','anio','url'],editor_revista:['revista','rol_editorial','anio','url'],peer_review:['revista','anio','url'],sup_tesis:['titulo_tesis','rol_tesis','tipo_tesis','programa_tesis','universidad','anio','url'],movilidad_inv:['nombre_evento','universidad','pais_evento','anio','url'],consultoria_alta:['nombre_cliente','tipo_cliente','alcance','anio','url'],puesto_directorio:['cargo_directorio','tipo_directorio','nombre_cliente','anio_inicio','anio_fin','anio','url'],media_regular:['nombre_medio','titulo_nota','tipo_participacion','alcance_medio','anio','url'],panelista_foro:['nombre_evento','organizador_ponencia','anio','url'],cargo_academico:['cargo_gestion','lider_academico','anio','url'],part_comite:['nombre_comite','rol_comite','convocante_comite','anio','url'],clase_ed_ejec:['tipo_ed_ejecutiva','rol_ed_ejecutiva','modulo_ed_ejecutiva','institucion_ed_ejecutiva','anio','url'],diseno_ed_ejec:['tipo_ed_ejecutiva','rol_ed_ejecutiva','institucion_ed_ejecutiva','anio','url'],comite_tecnico:['nombre_comite','rol_comite','convocante_comite','anio','url'],extension_com:['nombre_evento','organizador_extension','ciudad_extension','anio','url'],org_seminario:['nombre_evento','unidad_seminario','tipo_seminario','anio','url'],perfeccion_acad:['nombre_programa','tipo_perfeccionamiento','anio','url'],vcm_proyecto:['nombre_cliente','alcance','anio','url'],asoc_profesional:['nombre_comite','tipo_directorio','anio','url'],certificacion_prof:['nombre_programa','anio','url'],innovacion_docente:['nombre_curso','anio','url'],material_docente:['nombre_curso','tipo_material','descripcion_material','anio','url'],podcast_blog:['nombre_medio','titulo_nota','anio','url'],caso_conf_repos:['titulo_articulo','nombre_evento','anio','url'],caso_adoptado:['titulo_articulo','universidad','anio','url'],premio_academico:['nombre_evento','anio','url'],patente_pi:['titulo_articulo','anio','url'],policy_brief:['titulo_articulo','nombre_cliente','anio','url'],premio_sectorial:['nombre_evento','anio','url'],perito_arbitro:['nombre_cliente','anio','url'],_default:['anio','url','comentarios']};

const FL={titulo_articulo:'T√≠tulo',revista:'Revista',doi:'DOI',indice:'√çndice',cuartil:'Cuartil',anio_publicacion:'A√±o publicaci√≥n',anio:'A√±o',url:'URL',titulo_libro:'T√≠tulo libro',titulo_capitulo:'T√≠tulo cap√≠tulo',editorial:'Editorial',titulo_ponencia:'T√≠tulo ponencia',nombre_evento:'Evento',pais_evento:'Pa√≠s',tipo_conferencia:'Tipo conferencia',organizador_ponencia:'Organizador',tipo_ponencia:'Tipo ponencia',titulo_proyecto:'T√≠tulo proyecto',agencia:'Agencia',rol_proyecto:'Rol',financiamiento:'Financiamiento',fecha_adjudicacion:'Adjudicaci√≥n',titulo_wp:'T√≠tulo WP',institucion_serie:'Instituci√≥n',nombre_serie:'Serie',rol_editorial:'Rol editorial',titulo_tesis:'T√≠tulo tesis',rol_tesis:'Rol',tipo_tesis:'Tipo tesis',programa_tesis:'Programa',universidad:'Universidad',nombre_cliente:'Cliente/Org.',tipo_cliente:'Tipo',alcance:'Alcance',cargo_directorio:'Cargo',tipo_directorio:'Tipo',nombre_medio:'Medio',titulo_nota:'T√≠tulo',tipo_participacion:'Tipo participaci√≥n',alcance_medio:'Alcance',cargo_gestion:'Cargo',lider_academico:'L√≠der',nombre_comite:'Comit√©',rol_comite:'Rol',convocante_comite:'Convocante',tipo_ed_ejecutiva:'Tipo',rol_ed_ejecutiva:'Rol',modulo_ed_ejecutiva:'M√≥dulo',institucion_ed_ejecutiva:'Instituci√≥n',organizador_extension:'Organizador',ciudad_extension:'Ciudad',unidad_seminario:'Unidad',tipo_seminario:'Tipo',nombre_programa:'Programa',tipo_perfeccionamiento:'Tipo',nombre_curso:'Curso',tipo_material:'Tipo material',descripcion_material:'Descripci√≥n',comentarios:'Comentarios',anio_inicio:'A√±o inicio',anio_fin:'A√±o fin'};

async function loadData(){try{const r=await fetch('portafolio_data.json');if(!r.ok)throw 0;return await r.json();}catch(e){return null;}}
function normRut(r){return(r||'').replace(/\./g,'').replace(/\s/g,'').toUpperCase().trim();}
function dl(obj,fn){const b=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=fn;a.click();URL.revokeObjectURL(u);}
function desc(ev){return ev.titulo_articulo||ev.titulo_ponencia||ev.cargo_gestion||ev.titulo_nota||ev.nombre_evento||ev.titulo_wp||ev.titulo_tesis||ev.nombre_comite||ev.cargo_directorio||ev.nombre_programa||ev.nombre_cliente||ev.nombre_medio||ev.titulo_libro||ev.titulo_proyecto||'(sin descripci√≥n)';}

// ‚îÄ‚îÄ Login ‚îÄ‚îÄ
function Login({onLogin,onDean,ready,err}){
  const[rut,setRut]=useState('');const[dp,setDp]=useState('');const[sd,setSd]=useState(false);const[e,setE]=useState('');
  return <div className="login-box"><div className="card">
    <div className="login-logo">Portafolio Acad√©mico</div>
    <div style={{fontSize:13,color:'var(--text2)',marginBottom:4}}>Facultad de Econom√≠a y Negocios ¬∑ UNAB</div>
    <div style={{fontSize:12,color:'var(--warm)',fontWeight:600,marginBottom:24}}>Proceso de Acreditaci√≥n AACSB</div>
    {err&&<div className="banner" style={{textAlign:'left',marginBottom:20}}><div className="banner-title">‚ö† Datos no disponibles</div><div className="banner-text">Contacte a <span className="banner-email">{CONTACT_EMAIL}</span></div></div>}
    {!sd?<>
      <div className="login-desc">Ingrese su RUT para revisar su informaci√≥n acad√©mica y, si lo desea, complementarla o corregir datos existentes.</div>
      <div className="input-group"><label>RUT (sin puntos, con gui√≥n)</label>
        <input className="input" placeholder="12345678-9" value={rut} onChange={x=>{setRut(x.target.value);setE('');}} onKeyDown={x=>x.key==='Enter'&&onLogin(normRut(rut))} autoFocus/></div>
      {e&&<div style={{color:'var(--red)',fontSize:13,marginBottom:12,fontWeight:600}}>{e}</div>}
      <button className="btn btn-primary btn-block" onClick={()=>{const n=normRut(rut);if(!n||n.length<7){setE('RUT inv√°lido');return;}onLogin(n);}} disabled={!ready} style={{marginBottom:12}}>{ready?'Ingresar':'Cargando...'}</button>
      <button className="btn btn-outline btn-block btn-sm" onClick={()=>setSd(true)}>Acceso administrador</button>
    </>:<>
      <div className="login-desc">Clave de acceso administrativo.</div>
      <div className="input-group"><label>Clave</label><input className="input" type="password" value={dp} onChange={x=>{setDp(x.target.value);setE('');}} onKeyDown={x=>x.key==='Enter'&&(dp===DEAN_PASS?onDean():setE('Incorrecta'))} autoFocus/></div>
      {e&&<div style={{color:'var(--red)',fontSize:13,marginBottom:12,fontWeight:600}}>{e}</div>}
      <button className="btn btn-primary btn-block" onClick={()=>dp===DEAN_PASS?onDean():setE('Incorrecta')} style={{marginBottom:12}}>Ingresar</button>
      <button className="btn btn-outline btn-block btn-sm" onClick={()=>setSd(false)}>‚Üê Volver</button>
    </>}
  </div><div style={{textAlign:'center',marginTop:16,fontSize:11,color:'var(--text2)'}}>Direcci√≥n de Aseguramiento de la Calidad ¬∑ FEN-UNAB</div></div>;
}

// ‚îÄ‚îÄ Evidence Card (mirrors old gestion_evidencias.html display) ‚îÄ‚îÄ
function EvCard({ev,readOnly,onEdit}){
  const[editing,setEditing]=useState(false);
  const[edits,setEdits]=useState({});
  const fields=EDIT_FIELDS[ev.codigo]||EDIT_FIELDS._default;
  const allFields=fields.includes('comentarios')?fields:[...fields,'comentarios'];
  const d=desc(ev);
  const merged={...ev,...edits};
  const save=()=>{if(Object.keys(edits).length>0&&onEdit)onEdit(edits);setEditing(false);setEdits({});};

  return <div className="ev-card">
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:12,flexWrap:'wrap'}}>
      <div style={{flex:1,minWidth:200}}>
        <div style={{display:'flex',gap:8,alignItems:'center',marginBottom:4}}>
          <span style={{fontSize:13,fontWeight:700,color:'var(--accent)'}}>{ev.codigo}</span>
          <span style={{fontSize:12,color:'var(--text2)'}}>({ev.anio||'‚Äî'})</span>
        </div>
        {!editing&&<>
          <div style={{fontSize:13,color:'#374151',lineHeight:1.5}}>
            {d}{ev.revista&&<span style={{color:'var(--text2)'}}> ‚Äî {ev.revista}</span>}
          </div>
          {ev.doi&&<div style={{fontSize:12,marginTop:2}}><a href={ev.doi.startsWith('http')?ev.doi:`https://doi.org/${ev.doi}`} target="_blank" rel="noopener" style={{color:'var(--accent2)'}}>DOI: {ev.doi}</a></div>}
          {ev.url&&<div style={{fontSize:12,marginTop:2}}><a href={ev.url} target="_blank" rel="noopener" style={{color:'var(--accent2)'}}>üîó {ev.url.length>70?ev.url.substring(0,70)+'...':ev.url}</a></div>}
        </>}
      </div>
      {!readOnly&&<button className={`btn btn-sm ${editing?'btn-warm':'btn-outline'}`} onClick={()=>{if(editing)save();else setEditing(true);}}>
        {editing?'‚úì Guardar':'‚úé Editar'}
      </button>}
    </div>
    {editing&&<>
      <div className="edit-panel">
        <div className="full" style={{fontSize:12,fontWeight:600,color:'#92400e',marginBottom:4}}>Editando ‚Äî {CATALOGO[ev.codigo]||ev.codigo}</div>
        <div className="full"><label>Tipo de actividad</label>
          <select className="sel" style={{width:'100%'}} value={edits.codigo||ev.codigo} onChange={x=>setEdits({...edits,codigo:x.target.value})}>
            {Object.entries(CATALOGO).map(([k,v])=><option key={k} value={k}>{k} ‚Äî {v}</option>)}
          </select>
        </div>
        {allFields.map(f=>{const val=merged[f]||'';const isLink=(f==='url'||f==='doi')&&val;
          const href=f==='doi'&&val&&!val.startsWith('http')?`https://doi.org/${val}`:val;
          return <div key={f} style={(f==='url'||f==='comentarios')?{gridColumn:'1/-1'}:{}}>
            <label>{FL[f]||f}{isLink&&<a href={href} target="_blank" rel="noopener" style={{marginLeft:6,color:'var(--accent2)',fontWeight:400}}>abrir ‚Üó</a>}</label>
            <input className="input input-sm" value={val} onChange={x=>setEdits({...edits,[f]:x.target.value})}/>
          </div>;
        })}
      </div>
      <div style={{marginTop:8,display:'flex',gap:8}}>
        <button className="btn btn-warm btn-sm" onClick={save}>‚úì Guardar</button>
        <button className="btn btn-outline btn-sm" onClick={()=>{setEditing(false);setEdits({});}}>Cancelar</button>
      </div>
    </>}
  </div>;
}

// ‚îÄ‚îÄ Exp Card (editable) ‚îÄ‚îÄ
function ExpCard({exp,onEdit}){
  const[editing,setEditing]=useState(false);const[edits,setEdits]=useState({});
  const merged={...exp,...edits};const EF=['cargo','organizacion','anio_inicio','anio_fin'];
  const EL={cargo:'Cargo',organizacion:'Organizaci√≥n',anio_inicio:'A√±o inicio',anio_fin:'A√±o fin'};
  const save=()=>{if(Object.keys(edits).length>0&&onEdit)onEdit(edits);setEditing(false);setEdits({});};
  return <div className="ev-card">
    <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',gap:12}}>
      <div><div style={{fontWeight:600,fontSize:14}}>{exp.cargo||'(sin cargo)'} ‚Äî {exp.organizacion||'(sin organizaci√≥n)'}</div>
        <div style={{fontSize:12,color:'var(--text2)'}}>{exp.anio_inicio||'?'} ‚Äì {exp.anio_fin||'?'}</div></div>
      {onEdit&&<button className={`btn btn-sm ${editing?'btn-warm':'btn-outline'}`} onClick={()=>{if(editing)save();else setEditing(true);}}>
        {editing?'‚úì Guardar':'‚úé Editar'}</button>}
    </div>
    {editing&&<div className="edit-panel" style={{gridTemplateColumns:'1fr 1fr'}}>
      {EF.map(f=><div key={f}><label>{EL[f]}</label><input className="input input-sm" value={merged[f]||''} onChange={x=>setEdits({...edits,[f]:x.target.value})}/></div>)}
      <div style={{gridColumn:'1/-1',display:'flex',gap:8,marginTop:4}}>
        <button className="btn btn-warm btn-sm" onClick={save}>‚úì Guardar</button>
        <button className="btn btn-outline btn-sm" onClick={()=>{setEditing(false);setEdits({});}}>Cancelar</button>
      </div>
    </div>}
  </div>;
}

// ‚îÄ‚îÄ Professor View ‚îÄ‚îÄ
function ProfView({acad,evs,exps,onLogout}){
  const[tab,setTab]=useState('ev');
  const[ch,setCh]=useState({nuevas_evidencias:[],nuevas_exp:[],modificaciones_ev:[],modificaciones_exp:[]});
  const[showAddEv,setShowAddEv]=useState(false);const[showAddExp,setShowAddExp]=useState(false);
  const[submitted,setSubmitted]=useState(false);const[toast,setToast]=useState('');
  const st=(m)=>{setToast(m);setTimeout(()=>setToast(''),3000);};
  const total=ch.nuevas_evidencias.length+ch.nuevas_exp.length+ch.modificaciones_ev.length+ch.modificaciones_exp.length;

  const editEv=(evId,edits)=>{setCh(p=>{const i=p.modificaciones_ev.findIndex(m=>m.id_evidencia===evId);
    const mod={id_evidencia:evId,rut:acad.rut,cambios:edits,fecha:new Date().toISOString()};
    if(i>=0){const u=[...p.modificaciones_ev];u[i]={...u[i],cambios:{...u[i].cambios,...edits}};return{...p,modificaciones_ev:u};}
    return{...p,modificaciones_ev:[...p.modificaciones_ev,mod]};});st('‚úì Modificaci√≥n registrada');};

  const editExp=(idx,edits)=>{setCh(p=>{const i=p.modificaciones_exp.findIndex(m=>m.idx===idx);
    const mod={idx,rut:acad.rut,cambios:edits,cargo_original:exps[idx]?.cargo||'',fecha:new Date().toISOString()};
    if(i>=0){const u=[...p.modificaciones_exp];u[i]={...u[i],cambios:{...u[i].cambios,...edits}};return{...p,modificaciones_exp:u};}
    return{...p,modificaciones_exp:[...p.modificaciones_exp,mod]};});st('‚úì Modificaci√≥n registrada');};

  const[nev,setNev]=useState({codigo:'pub_paper',anio:String(new Date().getFullYear()),descripcion:'',revista:'',doi:'',url:'',comentarios:''});
  const addEv=()=>{if(!nev.descripcion.trim()){st('Ingrese descripci√≥n');return;}
    setCh(p=>({...p,nuevas_evidencias:[...p.nuevas_evidencias,{...nev,id:'PROF_'+Date.now(),rut:acad.rut,fecha_envio:new Date().toISOString()}]}));
    setNev({codigo:'pub_paper',anio:String(new Date().getFullYear()),descripcion:'',revista:'',doi:'',url:'',comentarios:''});setShowAddEv(false);st('‚úì Evidencia agregada');};

  const[nexp,setNexp]=useState({cargo:'',organizacion:'',anio_inicio:'',anio_fin:'',notas:''});
  const addExp=()=>{if(!nexp.cargo.trim()||!nexp.organizacion.trim()){st('Complete cargo y organizaci√≥n');return;}
    setCh(p=>({...p,nuevas_exp:[...p.nuevas_exp,{...nexp,id:'PROF_'+Date.now(),rut:acad.rut,fecha_envio:new Date().toISOString()}]}));
    setNexp({cargo:'',organizacion:'',anio_inicio:'',anio_fin:'',notas:''});setShowAddExp(false);st('‚úì Experiencia agregada');};

  const download=()=>{const payload={_formato:'cambios_portafolio_fen_v1',rut:acad.rut,nombre:acad.nombre,fecha_generacion:new Date().toISOString(),...ch};
    dl(payload,`cambios_${acad.rut.replace(/[^0-9kK]/g,'')}_${new Date().toISOString().slice(0,10).replace(/-/g,'')}.json`);setSubmitted(true);st('‚úì Descargado');};

  return <>
    <div className="header"><div className="header-inner">
      <div><h1>Portafolio Acad√©mico</h1><div className="header-sub">FEN-UNAB ¬∑ Acreditaci√≥n AACSB</div></div>
      <button className="btn btn-outline btn-sm" style={{color:'#fff',borderColor:'rgba(255,255,255,.3)'}} onClick={onLogout}>Cerrar sesi√≥n</button>
    </div></div>
    <div className="container">
      <div className="banner banner-critical"><div className="banner-title">üìß Importante: env√≠o de informaci√≥n</div>
        <div className="banner-text">Si modifica o agrega informaci√≥n, al finalizar debe <strong>descargar el archivo de cambios</strong> y enviarlo a:<br/>
          <span className="banner-email" style={{fontSize:16,display:'inline-block',margin:'6px 0'}}>{CONTACT_EMAIL}</span><br/>
          Sin este paso, sus cambios <strong>no ser√°n registrados</strong> en el sistema.</div></div>

      <div className="card">
        <div className="prof-name">{acad.nombre}</div>
        <div className="prof-meta">RUT: {acad.rut} ¬∑ {acad.planta||'‚Äî'} ¬∑ {acad.unidad||'‚Äî'}{acad.grado&&<> ¬∑ {acad.grado}</>}</div>
        <div className="prof-stats">
          <div className="stat-pill"><div className="stat-pill-v">{evs.length}</div><div className="stat-pill-l">Evidencias</div></div>
          <div className="stat-pill"><div className="stat-pill-v">{exps.length}</div><div className="stat-pill-l">Exp. Laboral</div></div>
        </div>
      </div>

      <div className="tabs">
        <button className={`tab ${tab==='ev'?'active':''}`} onClick={()=>setTab('ev')}>Evidencias ({evs.length}{ch.nuevas_evidencias.length?` + ${ch.nuevas_evidencias.length}`:''}{ch.modificaciones_ev.length?` ¬∑ ${ch.modificaciones_ev.length} mod.`:''})</button>
        <button className={`tab ${tab==='exp'?'active':''}`} onClick={()=>setTab('exp')}>Exp. Laboral ({exps.length}{ch.nuevas_exp.length?` + ${ch.nuevas_exp.length}`:''}{ch.modificaciones_exp.length?` ¬∑ ${ch.modificaciones_exp.length} mod.`:''})</button>
      </div>

      {tab==='ev'&&<div>
        <div style={{display:'flex',justifyContent:'flex-end',marginBottom:12}}>
          <button className="btn btn-warm btn-sm" onClick={()=>setShowAddEv(!showAddEv)}>{showAddEv?'‚úï Cancelar':'Ôºã Agregar evidencia'}</button>
        </div>
        {showAddEv&&<div className="add-form">
          <div style={{fontWeight:700,fontSize:14,marginBottom:12,color:'var(--warm)'}}>Nueva evidencia</div>
          <div className="form-grid">
            <div className="input-group"><label>Tipo de actividad</label><select className="sel" style={{width:'100%'}} value={nev.codigo} onChange={x=>setNev({...nev,codigo:x.target.value})}>{Object.entries(CATALOGO).map(([k,v])=><option key={k} value={k}>{v}</option>)}</select></div>
            <div className="input-group"><label>A√±o</label><input className="input input-sm" type="number" value={nev.anio} onChange={x=>setNev({...nev,anio:x.target.value})}/></div>
          </div>
          <div className="input-group"><label>Descripci√≥n</label><input className="input" value={nev.descripcion} onChange={x=>setNev({...nev,descripcion:x.target.value})} placeholder="T√≠tulo, nombre del proyecto, cargo, etc."/></div>
          {['pub_paper','pub_pedagogica'].includes(nev.codigo)&&<div className="form-grid">
            <div className="input-group"><label>Revista</label><input className="input input-sm" value={nev.revista} onChange={x=>setNev({...nev,revista:x.target.value})}/></div>
            <div className="input-group"><label>DOI</label><input className="input input-sm" value={nev.doi} onChange={x=>setNev({...nev,doi:x.target.value})}/></div>
          </div>}
          <div className="form-grid">
            <div className="input-group"><label>URL de respaldo</label><input className="input input-sm" value={nev.url} onChange={x=>setNev({...nev,url:x.target.value})}/></div>
            <div className="input-group"><label>Comentarios</label><input className="input input-sm" value={nev.comentarios} onChange={x=>setNev({...nev,comentarios:x.target.value})}/></div>
          </div>
          <button className="btn btn-warm" onClick={addEv}>Agregar</button>
        </div>}
        {ch.nuevas_evidencias.map((ev,i)=><div key={'n'+i} className="ev-card ev-new"><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div><span style={{fontSize:11,fontWeight:700,color:'#a04000',background:'#fdebd0',padding:'2px 8px',borderRadius:4}}>NUEVA ‚Äî pendiente de env√≠o</span>
            <div style={{marginTop:6,fontWeight:600,fontSize:14}}>{ev.descripcion}</div>
            <div style={{fontSize:12,color:'var(--text2)'}}>{CATALOGO[ev.codigo]||ev.codigo} ¬∑ {ev.anio}</div></div>
          <button className="btn btn-outline btn-sm" onClick={()=>{setCh(p=>({...p,nuevas_evidencias:p.nuevas_evidencias.filter((_,j)=>j!==i)}));st('Removida');}}>‚úï</button>
        </div></div>)}
        {evs.length===0&&ch.nuevas_evidencias.length===0&&<div className="empty">No hay evidencias registradas.</div>}
        {evs.map((ev,i)=><EvCard key={ev.id_evidencia||i} ev={ev} readOnly={false} onEdit={(edits)=>editEv(ev.id_evidencia,edits)}/>)}
      </div>}

      {tab==='exp'&&<div>
        <div style={{display:'flex',justifyContent:'flex-end',marginBottom:12}}>
          <button className="btn btn-warm btn-sm" onClick={()=>setShowAddExp(!showAddExp)}>{showAddExp?'‚úï Cancelar':'Ôºã Agregar experiencia'}</button>
        </div>
        {showAddExp&&<div className="add-form">
          <div style={{fontWeight:700,fontSize:14,marginBottom:12,color:'var(--warm)'}}>Nueva experiencia laboral</div>
          <div className="form-grid">
            <div className="input-group"><label>Cargo</label><input className="input input-sm" value={nexp.cargo} onChange={x=>setNexp({...nexp,cargo:x.target.value})}/></div>
            <div className="input-group"><label>Organizaci√≥n</label><input className="input input-sm" value={nexp.organizacion} onChange={x=>setNexp({...nexp,organizacion:x.target.value})}/></div>
          </div>
          <div className="form-grid">
            <div className="input-group"><label>A√±o inicio</label><input className="input input-sm" type="number" value={nexp.anio_inicio} onChange={x=>setNexp({...nexp,anio_inicio:x.target.value})}/></div>
            <div className="input-group"><label>A√±o fin (o "vigente")</label><input className="input input-sm" value={nexp.anio_fin} onChange={x=>setNexp({...nexp,anio_fin:x.target.value})}/></div>
          </div>
          <div className="input-group"><label>Notas</label><input className="input input-sm" value={nexp.notas} onChange={x=>setNexp({...nexp,notas:x.target.value})}/></div>
          <button className="btn btn-warm" onClick={addExp}>Agregar</button>
        </div>}
        {ch.nuevas_exp.map((exp,i)=><div key={'n'+i} className="ev-card ev-new"><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}>
          <div><span style={{fontSize:11,fontWeight:700,color:'#a04000',background:'#fdebd0',padding:'2px 8px',borderRadius:4}}>NUEVA ‚Äî pendiente de env√≠o</span>
            <div style={{marginTop:6,fontWeight:600,fontSize:14}}>{exp.cargo} ‚Äî {exp.organizacion}</div>
            <div style={{fontSize:12,color:'var(--text2)'}}>{exp.anio_inicio}{exp.anio_fin?' ‚Äì '+exp.anio_fin:''}</div></div>
          <button className="btn btn-outline btn-sm" onClick={()=>setCh(p=>({...p,nuevas_exp:p.nuevas_exp.filter((_,j)=>j!==i)}))}>‚úï</button>
        </div></div>)}
        {exps.length===0&&ch.nuevas_exp.length===0&&<div className="empty">Sin experiencia laboral.</div>}
        {exps.map((exp,i)=><ExpCard key={i} exp={exp} onEdit={(edits)=>editExp(i,edits)}/>)}
      </div>}

      {total>0&&!submitted&&<div className="changes-bar">
        <div style={{display:'flex',alignItems:'center',gap:12}}><div className="pulse"/>
          <div><strong>{total} cambio{total>1?'s':''} pendiente{total>1?'s':''}</strong><div style={{fontSize:12,opacity:.8}}>Descargue y env√≠e a {CONTACT_EMAIL}</div></div>
        </div>
        <button className="btn" style={{background:'#f39c12',color:'#fff'}} onClick={download}>üì• Descargar archivo</button>
      </div>}

      {submitted&&<div className="card" style={{background:'var(--green-light)',border:'1.5px solid var(--green)',textAlign:'center',padding:32}}>
        <div style={{fontSize:24,marginBottom:8}}>‚úÖ</div>
        <div style={{fontSize:18,fontWeight:700,color:'var(--green)',marginBottom:12}}>Archivo descargado</div>
        <div style={{fontSize:14,lineHeight:1.7,maxWidth:500,margin:'0 auto'}}>
          Env√≠e <strong>cambios_*.json</strong> a:<br/>
          <span style={{fontSize:18,fontWeight:700,color:'var(--accent)',display:'inline-block',margin:'12px 0'}}>{CONTACT_EMAIL}</span><br/>
          Sin esto, sus cambios <strong>no quedar√°n registrados</strong>.</div>
        <div style={{marginTop:20,display:'flex',gap:12,justifyContent:'center',flexWrap:'wrap'}}>
          <button className="btn btn-primary" onClick={()=>{window.location.href=`mailto:${CONTACT_EMAIL}?subject=Portafolio%20-%20${encodeURIComponent(acad.nombre)}&body=Adjunto%20archivo%20de%20cambios.`;}}>üìß Abrir correo</button>
          <button className="btn btn-outline" onClick={()=>setSubmitted(false)}>Seguir editando</button>
        </div>
      </div>}
    </div>
    {toast&&<div className="toast">{toast}</div>}
  </>;
}

// ‚îÄ‚îÄ Dean View ‚îÄ‚îÄ
function DeanView({data,onLogout}){
  const[sel,setSel]=useState(null);const[filter,setFilter]=useState('');
  const acads=useMemo(()=>(data.academicos||[]).filter(a=>{if(!filter)return true;const q=filter.toLowerCase();return(a.nombre||'').toLowerCase().includes(q)||(a.rut||'').includes(q)||(a.unidad||'').toLowerCase().includes(q);}).sort((a,b)=>(a.nombre||'').localeCompare(b.nombre||'')),[data,filter]);
  const evm=useMemo(()=>{const m={};(data.evidencias||[]).forEach(e=>{if(!m[e.rut])m[e.rut]=[];m[e.rut].push(e);});return m;},[data]);
  const exm=useMemo(()=>{const m={};(data.exp_laboral||[]).forEach(e=>{if(!m[e.rut])m[e.rut]=[];m[e.rut].push(e);});return m;},[data]);

  if(sel){const acad=data.academicos.find(a=>a.rut===sel);if(!acad){setSel(null);return null;}
    const evs=evm[sel]||[];const exps=exm[sel]||[];
    return <><div className="header"><div className="header-inner"><div><h1>Vista Administrador</h1><div className="header-sub">Solo lectura</div></div>
      <div style={{display:'flex',gap:8}}><button className="btn btn-outline btn-sm" style={{color:'#fff',borderColor:'rgba(255,255,255,.3)'}} onClick={()=>setSel(null)}>‚Üê Lista</button>
        <button className="btn btn-outline btn-sm" style={{color:'#fff',borderColor:'rgba(255,255,255,.3)'}} onClick={onLogout}>Salir</button></div>
    </div></div><div className="container">
      <div className="card"><div className="prof-name">{acad.nombre}</div><div className="prof-meta">RUT: {acad.rut} ¬∑ {acad.planta||'‚Äî'} ¬∑ {acad.unidad||'‚Äî'}{acad.grado&&<> ¬∑ {acad.grado}</>}</div></div>
      <div style={{fontWeight:700,fontSize:14,color:'var(--accent)',marginBottom:12}}>Evidencias ({evs.length})</div>
      {evs.length===0&&<div className="empty">Sin evidencias.</div>}
      {evs.map((ev,i)=><EvCard key={i} ev={ev} readOnly={true}/>)}
      <div style={{fontWeight:700,fontSize:14,color:'var(--accent)',marginTop:24,marginBottom:12}}>Experiencia Laboral ({exps.length})</div>
      {exps.length===0&&<div className="empty">Sin experiencia laboral.</div>}
      {exps.map((exp,i)=><div key={i} className="ev-card"><div style={{fontWeight:600,fontSize:14}}>{exp.cargo||'‚Äî'} ‚Äî {exp.organizacion||'‚Äî'}</div><div style={{fontSize:12,color:'var(--text2)'}}>{exp.anio_inicio||'?'} ‚Äì {exp.anio_fin||'?'}</div></div>)}
    </div></>;
  }

  const te=(data.evidencias||[]).length;const tx=(data.exp_laboral||[]).length;const pr=acads.filter(a=>(a.planta||'').toLowerCase().includes('regular')).length;
  return <><div className="header"><div className="header-inner"><div><h1>Vista Administrador</h1><div className="header-sub">Solo lectura</div></div>
    <button className="btn btn-outline btn-sm" style={{color:'#fff',borderColor:'rgba(255,255,255,.3)'}} onClick={onLogout}>Salir</button></div></div>
    <div className="container">
      <div className="dean-stats">
        <div className="dean-stat"><div className="dean-stat-v" style={{color:'var(--accent)'}}>{acads.length}</div><div className="dean-stat-l">Acad√©micos</div></div>
        <div className="dean-stat"><div className="dean-stat-v" style={{color:'var(--green)'}}>{pr}</div><div className="dean-stat-l">Regulares</div></div>
        <div className="dean-stat"><div className="dean-stat-v" style={{color:'var(--warm)'}}>{te}</div><div className="dean-stat-l">Evidencias</div></div>
        <div className="dean-stat"><div className="dean-stat-v">{tx}</div><div className="dean-stat-l">Exp. Laboral</div></div>
      </div>
      <div className="card"><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16,gap:12,flexWrap:'wrap'}}>
        <div className="card-title" style={{margin:0}}>Acad√©micos</div>
        <input className="input input-sm" style={{maxWidth:300}} placeholder="Buscar..." value={filter} onChange={x=>setFilter(x.target.value)}/></div>
        <div className="scroll-table"><table className="tbl"><thead><tr><th>Nombre</th><th>RUT</th><th>Planta</th><th>Unidad</th><th>Evid.</th></tr></thead>
        <tbody>{acads.map(a=><tr key={a.rut} onClick={()=>setSel(a.rut)}>
          <td style={{fontWeight:600}}>{a.nombre}</td><td style={{fontFamily:'monospace',fontSize:12}}>{a.rut}</td>
          <td>{a.planta||'‚Äî'}</td><td>{a.unidad||'‚Äî'}</td><td>{(evm[a.rut]||[]).length}</td>
        </tr>)}</tbody></table></div>
      </div>
    </div>
  </>;
}

// ‚îÄ‚îÄ App ‚îÄ‚îÄ
function App(){
  const[data,setData]=useState(null);const[err,setErr]=useState(false);const[mode,setMode]=useState('login');const[acad,setAcad]=useState(null);
  useEffect(()=>{loadData().then(d=>{if(d)setData(d);else setErr(true);});},[]);
  const login=(rut)=>{if(!data)return;const a=data.academicos.find(x=>normRut(x.rut)===rut);
    if(!a){alert('RUT no encontrado.\n\nContacte a:\n'+CONTACT_EMAIL);return;}setAcad(a);setMode('prof');};
  const logout=()=>{setMode('login');setAcad(null);};
  if(mode==='login')return <Login onLogin={login} onDean={()=>setMode('dean')} ready={!!data} err={err}/>;
  if(mode==='dean')return <DeanView data={data} onLogout={logout}/>;
  if(mode==='prof'&&acad){const evs=(data.evidencias||[]).filter(e=>e.rut===acad.rut);const exps=(data.exp_laboral||[]).filter(e=>e.rut===acad.rut);
    return <ProfView acad={acad} evs={evs} exps={exps} onLogout={logout}/>;}
  return null;
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
